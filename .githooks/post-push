#!/bin/bash

echo "ğŸš€ Push completed! Starting deployment monitoring..."

# Function to check if command exists
command_exists() {
  command -v "$1" >/dev/null 2>&1
}

# Check if we're pushing to master
BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ "$BRANCH" != "master" ] && [ "$BRANCH" != "main" ]; then
  echo "â„¹ï¸ Not pushing to main branch, skipping deployment monitoring"
  exit 0
fi

# Get the latest commit hash
COMMIT_SHA=$(git rev-parse HEAD)
echo "ğŸ“¦ Monitoring deployment for commit: ${COMMIT_SHA:0:7}"

if command_exists gh; then
  echo "ğŸ‘€ Watching GitHub Actions deployment..."
  echo "ğŸ“ You can also view at: https://github.com/$(gh repo view --json nameWithOwner -q .nameWithOwner)/actions"
  echo ""
  
  # Wait a moment for the workflow to start
  echo "â³ Waiting for workflow to start..."
  sleep 5
  
  # Get the latest workflow run ID
  RUN_ID=$(gh run list --limit 1 --json databaseId --jq '.[0].databaseId')
  
  if [ -n "$RUN_ID" ]; then
    echo "ğŸ” Found workflow run: $RUN_ID"
    echo "ğŸ“Š Starting live monitoring..."
    echo ""
    
    # Watch the workflow with detailed output
    if gh run watch "$RUN_ID" --exit-status; then
      echo ""
      echo "âœ… Deployment completed successfully!"
      echo "ğŸ‰ Your Pi should now be running the latest version"
      
      # Show final status
      gh run view "$RUN_ID" --json conclusion,status --jq '"Final Status: " + .status + " (" + .conclusion + ")"'
    else
      echo ""
      echo "âŒ Deployment failed!"
      echo ""
      echo "ğŸ” Fetching error details..."
      
      # Get detailed failure information
      gh run view "$RUN_ID" --json jobs --jq '.jobs[] | select(.conclusion == "failure") | "âŒ Job: " + .name + "\n   Status: " + .conclusion + "\n   URL: " + .url'
      
      echo ""
      echo "ğŸ“ Recent logs from failed job:"
      FAILED_JOB=$(gh run view "$RUN_ID" --json jobs --jq '.jobs[] | select(.conclusion == "failure") | .name' | head -1)
      if [ -n "$FAILED_JOB" ]; then
        echo "--- Last 20 lines of '$FAILED_JOB' ---"
        gh run view "$RUN_ID" --log --job "$FAILED_JOB" | tail -20
        echo "--- End of logs ---"
      fi
      
      echo ""
      echo "ğŸ”— Full details: https://github.com/$(gh repo view --json nameWithOwner -q .nameWithOwner)/actions/runs/$RUN_ID"
      
      # Exit with error code
      exit 1
    fi
  else
    echo "âš ï¸ Could not find workflow run, it may not have started yet"
    echo "ğŸ”— Check manually: https://github.com/$(gh repo view --json nameWithOwner -q .nameWithOwner)/actions"
  fi
  
else
  echo "âš ï¸ GitHub CLI not installed"
  echo "ğŸ’¡ Install with: brew install gh && gh auth login"
  echo "ğŸ”— Monitor deployment at: https://github.com/White-Plains-Gospel-Chapel/sermon-uploader/actions"
fi