#!/bin/bash

echo "ğŸš€ Push completed! Starting deployment monitoring..."

# Function to check if command exists
command_exists() {
  command -v "$1" >/dev/null 2>&1
}

# Check if we're pushing to master
BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ "$BRANCH" != "master" ] && [ "$BRANCH" != "main" ]; then
  echo "â„¹ï¸ Not pushing to main branch, skipping deployment monitoring"
  exit 0
fi

# Get the latest commit hash
COMMIT_SHA=$(git rev-parse HEAD)
echo "ğŸ“¦ Monitoring deployment for commit: ${COMMIT_SHA:0:7}"

if command_exists gh; then
  echo "ğŸ‘€ Watching GitHub Actions deployment..."
  echo "ğŸ“ You can also view at: https://github.com/$(gh repo view --json nameWithOwner -q .nameWithOwner)/actions"
  echo ""
  
  # Wait a moment for the workflow to start
  sleep 3
  
  # Watch the latest workflow run
  gh run watch --exit-status || {
    echo "âŒ Deployment failed or was cancelled"
    echo "ğŸ” Check details at: https://github.com/$(gh repo view --json nameWithOwner -q .nameWithOwner)/actions"
    exit 1
  }
  
  echo "âœ… Deployment completed successfully!"
  echo "ğŸ‰ Your Pi should now be running the latest version"
  
else
  echo "âš ï¸ GitHub CLI not installed"
  echo "ğŸ’¡ Install with: brew install gh"
  echo "ğŸ”— Monitor deployment at: https://github.com/White-Plains-Gospel-Chapel/sermon-uploader/actions"
fi