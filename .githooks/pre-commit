#!/bin/bash
set -e

echo "ğŸ” Running pre-commit checks..."

# Check if we're in the right directory
if [ ! -f "backend/go.mod" ]; then
  echo "âŒ Not in project root directory"
  exit 1
fi

# Function to check if command exists
command_exists() {
  command -v "$1" >/dev/null 2>&1
}

# Check Go backend
echo "ğŸ”§ Checking Go backend..."
if command_exists go; then
  cd backend
  
  # Check Go modules
  echo "  ğŸ“¦ Verifying Go modules..."
  go mod verify || {
    echo "âŒ Go modules verification failed"
    exit 1
  }
  
  # Check for Go syntax/compile errors
  echo "  ğŸ—ï¸ Building Go backend..."
  go build -o /tmp/sermon-uploader . || {
    echo "âŒ Go build failed"
    exit 1
  }
  
  # Run Go vet (catches common errors)
  echo "  ğŸ” Running go vet..."
  go vet ./... || {
    echo "âŒ Go vet found issues"
    exit 1
  }
  
  # Check Go formatting
  echo "  ğŸ“ Checking Go formatting..."
  UNFORMATTED=$(gofmt -l .)
  if [ -n "$UNFORMATTED" ]; then
    echo "âŒ Go files need formatting:"
    echo "$UNFORMATTED"
    echo "Run: gofmt -w ."
    exit 1
  fi
  
  cd ..
  echo "âœ… Go backend checks passed"
else
  echo "âš ï¸ Go not found, skipping Go checks"
fi

# Check Frontend (lightweight check)
echo "ğŸ¨ Checking Frontend..."
if command_exists npm && [ -f "frontend/package.json" ]; then
  cd frontend
  
  # Check if node_modules exists
  if [ ! -d "node_modules" ]; then
    echo "  âš ï¸ node_modules not found, skipping frontend checks"
    echo "  ğŸ’¡ Run 'npm ci' to install dependencies"
  else
    # TypeScript compile check (quick)
    echo "  ğŸ”· Checking TypeScript compilation..."
    npx tsc --noEmit --skipLibCheck || {
      echo "âŒ TypeScript compilation failed"
      exit 1
    }
  fi
  
  cd ..
  echo "âœ… Frontend checks passed"
else
  echo "âš ï¸ npm not found or no package.json, skipping frontend checks"
fi

echo "ğŸ‰ All pre-commit checks passed! Safe to commit."