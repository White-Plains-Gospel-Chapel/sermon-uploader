#!/bin/bash
set -e

echo "ğŸš€ Running pre-push checks..."

# Additional checks before pushing to avoid deployment failures
echo "ğŸ—ï¸ Performing comprehensive build test..."

# Test Docker build completely (not just syntax)
if command -v docker >/dev/null 2>&1; then
  echo "ğŸ³ Testing full Docker build..."
  docker build -t sermon-uploader-precheck . || {
    echo "âŒ Docker build failed - would fail in GitHub Actions"
    exit 1
  }
  
  # Clean up test image
  docker rmi sermon-uploader-precheck >/dev/null 2>&1 || true
  echo "âœ… Docker build test passed"
fi

# Test docker-compose with pull simulation
if command -v docker-compose >/dev/null 2>&1; then
  echo "ğŸ“‹ Testing docker-compose configurations..."
  for compose_file in docker-compose*.yml; do
    if [ -f "$compose_file" ]; then
      echo "  ğŸ” Testing $compose_file services..."
      docker-compose -f "$compose_file" config --quiet || {
        echo "âŒ $compose_file configuration invalid"
        exit 1
      }
    fi
  done
fi

echo "âœ… Pre-push checks passed - safe to deploy!"