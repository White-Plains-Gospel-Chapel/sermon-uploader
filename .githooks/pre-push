#!/bin/bash
set -e

echo "ğŸš€ Running pre-push checks..."

# Check if we're pushing to master/main - only then run Pi checks
BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ "$BRANCH" = "master" ] || [ "$BRANCH" = "main" ]; then
  echo "ğŸ¯ Pushing to $BRANCH - running Pi deployment verification..."
  
  # Ask user if they want to run Pi checks (saves time for non-deployment pushes)
  echo ""
  echo "ğŸ’° Running Pi checks now saves GitHub Actions minutes!"
  echo "ğŸ” Do you want to verify Pi connectivity before pushing? (Y/n)"
  read -r -t 10 RESPONSE || RESPONSE="y"
  
  if [ "$RESPONSE" = "n" ] || [ "$RESPONSE" = "N" ]; then
    echo "âš ï¸ Skipping Pi verification - deployment may fail in GitHub Actions"
  else
    echo "ğŸ” Running Pi verification..."
    if [ -f "./pre-deploy-check.sh" ]; then
      ./pre-deploy-check.sh || {
        echo ""
        echo "âŒ Pi verification failed!"
        echo "ğŸ’° This would have failed in GitHub Actions (costing money)"
        echo "ğŸ”§ Fix the issues above before pushing"
        exit 1
      }
    else
      echo "âš ï¸ pre-deploy-check.sh not found, skipping Pi verification"
    fi
  fi
else
  echo "â„¹ï¸ Not pushing to main branch, skipping Pi verification"
fi

# Additional checks before pushing to avoid deployment failures
echo ""
echo "ğŸ—ï¸ Performing comprehensive build test..."

# Test Docker build completely (not just syntax)
if command -v docker >/dev/null 2>&1; then
  echo "ğŸ³ Testing full Docker build..."
  docker build -t sermon-uploader-precheck . || {
    echo "âŒ Docker build failed - would fail in GitHub Actions"
    exit 1
  }
  
  # Clean up test image
  docker rmi sermon-uploader-precheck >/dev/null 2>&1 || true
  echo "âœ… Docker build test passed"
fi

# Test docker-compose with pull simulation
if command -v docker-compose >/dev/null 2>&1; then
  echo "ğŸ“‹ Testing docker-compose configurations..."
  for compose_file in docker-compose*.yml; do
    if [ -f "$compose_file" ]; then
      echo "  ğŸ” Testing $compose_file services..."
      docker-compose -f "$compose_file" config --quiet || {
        echo "âŒ $compose_file configuration invalid"
        exit 1
      }
    fi
  done
fi

echo "âœ… Pre-push checks passed - safe to deploy!"

# Auto-start deployment monitoring in background after push
echo ""
echo "ğŸ“º Starting automatic deployment monitoring..."
(
  # Wait for push to complete and workflow to start
  sleep 10
  
  echo ""
  echo "ğŸš€ Deployment monitoring started automatically..."
  ./watch-deployment.sh
) &
echo "ğŸ’¡ Monitoring will start automatically in background after push completes"
echo ""