name: Deploy to Raspberry Pi

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Pi
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 0
      
      - name: Pull latest and deploy
        run: |
          echo "ğŸš€ Deploying commit: $(git rev-parse --short HEAD)"
          
          # Ensure we have latest code
          git pull origin master || git pull origin main
          
          # Create .env file with defaults if secrets aren't set
          cat > .env << EOL
          MINIO_ENDPOINT=localhost:9000
          MINIO_ACCESS_KEY=gaius
          MINIO_SECRET_KEY=John 3:16
          MINIO_SECURE=false
          MINIO_BUCKET=sermons
          DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }}
          WAV_SUFFIX=_raw
          AAC_SUFFIX=_streamable
          BATCH_THRESHOLD=2
          PORT=8000
          EOL
          
          # Build Docker image locally
          echo "ğŸ—ï¸ Building Docker image..."
          docker build -t sermon-uploader:latest .
          
          # Stop old container and start new one
          echo "ğŸ”„ Restarting container..."
          docker compose -f docker-compose.single.yml down || true
          docker compose -f docker-compose.single.yml up -d
          
          # Wait for service to start
          sleep 15
          
          # Health check
          echo "ğŸ¥ Checking health..."
          for i in {1..5}; do
            if curl -f http://localhost:8000/api/health >/dev/null 2>&1; then
              echo "âœ… Deployment successful!"
              break
            elif [ $i -eq 5 ]; then
              echo "âŒ Health check failed"
              docker compose -f docker-compose.single.yml logs --tail=50
              exit 1
            else
              echo "â³ Retry $i/5..."
              sleep 5
            fi
          done
          
          # Clean up old images
          docker image prune -af --filter="until=24h" || true
          
          echo "ğŸ‰ Deployment complete!"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.CreatedAt}}"