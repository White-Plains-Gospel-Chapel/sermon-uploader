name: Issue-Specific PR Validation

on:
  pull_request:
    types: [opened, synchronize, edited]

jobs:
  issue-specific-validation:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Extract issue number and validate
      run: |
        PR_NUMBER=${{ github.event.pull_request.number }}
        PR_BODY="${{ github.event.pull_request.body }}"
        PR_TITLE="${{ github.event.pull_request.title }}"
        
        # Extract issue number from PR body
        ISSUE_NUM=$(echo "$PR_BODY" | grep -oiE "(closes?|fixes?|resolves?) #([0-9]+)" | grep -oE "[0-9]+" | head -1)
        
        if [ -z "$ISSUE_NUM" ]; then
          echo "::warning::No issue reference found, skipping issue-specific validation"
          exit 0
        fi
        
        echo "ðŸŽ¯ Validating PR for Issue #${ISSUE_NUM}"
        
        # Check for issue dependencies and linking
        echo "ðŸ”— Checking issue dependencies..."
        
        # Get issue details and check for dependency labels/content
        ISSUE_DETAILS=$(gh issue view $ISSUE_NUM --json body,labels,title)
        ISSUE_LABELS=$(echo "$ISSUE_DETAILS" | jq -r '.labels[].name' | tr '\n' ',' | sed 's/,$//')
        ISSUE_TITLE_TEXT=$(echo "$ISSUE_DETAILS" | jq -r '.title')
        ISSUE_BODY_TEXT=$(echo "$ISSUE_DETAILS" | jq -r '.body // ""')
        
        echo "Issue labels: $ISSUE_LABELS"
        
        # Check if this is a sub-task
        IS_SUBTASK=false
        PARENT_ISSUE=""
        DEPENDENCIES=()
        
        if [[ "$ISSUE_TITLE_TEXT" =~ ^Sub-task: ]]; then
          IS_SUBTASK=true
          echo "ðŸ“‹ This is a sub-task"
          
          # Extract parent issue from sub-task patterns
          case "$ISSUE_NUM" in
            4|5) PARENT_ISSUE="1" ;;  # CloudFlare sub-tasks
            6|7) PARENT_ISSUE="2" ;;  # VPN sub-tasks  
            8|9|10) PARENT_ISSUE="3" ;; # Webhook sub-tasks
            11) DEPENDENCIES=("1" "2" "3") ;; # Integration testing depends on all main issues
          esac
        fi
        
        # Check dependencies if this is a sub-task or has dependencies
        if [ -n "$PARENT_ISSUE" ]; then
          echo "ðŸ” Checking parent issue #${PARENT_ISSUE} status..."
          PARENT_STATUS=$(gh issue view $PARENT_ISSUE --json state | jq -r '.state')
          if [ "$PARENT_STATUS" = "open" ]; then
            echo "âš ï¸ Parent issue #${PARENT_ISSUE} is still open"
            # This is informational, not blocking
          fi
        fi
        
        if [ ${#DEPENDENCIES[@]} -gt 0 ]; then
          echo "ðŸ” Checking dependency issues: ${DEPENDENCIES[*]}..."
          UNRESOLVED_DEPS=()
          for dep in "${DEPENDENCIES[@]}"; do
            DEP_STATUS=$(gh issue view $dep --json state | jq -r '.state')
            if [ "$DEP_STATUS" = "open" ]; then
              UNRESOLVED_DEPS+=("#$dep")
            fi
          done
          
          if [ ${#UNRESOLVED_DEPS[@]} -gt 0 ]; then
            echo "âš ï¸ Some dependencies are still open: ${UNRESOLVED_DEPS[*]}"
            # For integration testing, this should be blocking
            if [ "$ISSUE_NUM" = "11" ]; then
              MISSING+=("âŒ Dependencies must be resolved first: ${UNRESOLVED_DEPS[*]}")
              VALIDATION_FAILED=true
            fi
          fi
        fi
        
        # Check if this PR needs more information
        NEEDS_MORE_INFO=false
        if echo "$PR_BODY" | grep -iE "(need.*more|insufficient.*detail|unclear|please.*clarify)" > /dev/null; then
          NEEDS_MORE_INFO=true
        fi
        
        # Check for related issue references
        RELATED_ISSUES=$(echo "$PR_BODY" | grep -oiE "(relates? to|related|see also|depends on) #([0-9]+)" | grep -oE "[0-9]+" || true)
        if [ -n "$RELATED_ISSUES" ]; then
          echo "ðŸ”— Found related issues: $(echo $RELATED_ISSUES | tr '\n' ',' | sed 's/,$//')"
        fi
        
        VALIDATION_FAILED=false
        REQUIREMENTS=()
        MISSING=()
        
        # Issue-specific validation rules
        case "$ISSUE_NUM" in
          1)
            # CloudFlare Tunnel Implementation
            echo "ðŸ“¡ Validating CloudFlare Tunnel implementation..."
            REQUIREMENTS+=("âœ“ CloudFlare tunnel configuration file")
            REQUIREMENTS+=("âœ“ Tunnel authentication/credentials setup")
            REQUIREMENTS+=("âœ“ Public URL testing evidence")
            REQUIREMENTS+=("âœ“ No exposed ports verification")
            
            if ! echo "$PR_BODY" | grep -iE "(tunnel|cloudflare|cloudflared)" > /dev/null; then
              MISSING+=("âŒ Must mention CloudFlare tunnel configuration")
              VALIDATION_FAILED=true
            fi
            
            if ! echo "$PR_BODY" | grep -iE "(test.*url|public.*access|tunnel.*test)" > /dev/null; then
              MISSING+=("âŒ Must include public URL testing evidence")
              VALIDATION_FAILED=true
            fi
            
            if ! echo "$PR_BODY" | grep -iE "(no.*port|port.*closed|zero.*exposure)" > /dev/null; then
              MISSING+=("âš ï¸ Should verify no ports are exposed")
            fi
            ;;
            
          2)
            # VPN Configuration
            echo "ðŸ” Validating VPN configuration..."
            REQUIREMENTS+=("âœ“ VPN connection testing from external network")
            REQUIREMENTS+=("âœ“ Admin access verification")
            REQUIREMENTS+=("âœ“ Network routing documentation")
            
            if ! echo "$PR_BODY" | grep -iE "(vpn|teleport|identity|route)" > /dev/null; then
              MISSING+=("âŒ Must document VPN configuration")
              VALIDATION_FAILED=true
            fi
            
            if ! echo "$PR_BODY" | grep -iE "(test|verified|working|success)" > /dev/null; then
              MISSING+=("âš ï¸ Should include testing verification")
            fi
            ;;
            
          3)
            # Webhook Deployment System
            echo "ðŸª Validating webhook deployment..."
            REQUIREMENTS+=("âœ“ Webhook security configuration (secret)")
            REQUIREMENTS+=("âœ“ Systemd service configuration")
            REQUIREMENTS+=("âœ“ GitHub Actions workflow update")
            REQUIREMENTS+=("âœ“ Deployment testing evidence")
            
            if ! echo "$PR_BODY" | grep -iE "(webhook.*secret|hmac|signature.*verif)" > /dev/null; then
              MISSING+=("âŒ Must include webhook security (secret/HMAC)")
              VALIDATION_FAILED=true
            fi
            
            if ! echo "$PR_BODY" | grep -iE "(systemd|service|daemon)" > /dev/null; then
              MISSING+=("âŒ Must configure systemd service")
              VALIDATION_FAILED=true
            fi
            
            if ! echo "$PR_BODY" | grep -iE "(github.*action|workflow|\.github)" > /dev/null; then
              MISSING+=("âŒ Must update GitHub Actions workflow")
              VALIDATION_FAILED=true
            fi
            
            if ! echo "$PR_BODY" | grep -iE "(deploy.*test|test.*deploy|deployment.*work)" > /dev/null; then
              MISSING+=("âŒ Must include deployment testing evidence")
              VALIDATION_FAILED=true
            fi
            ;;
            
          4)
            # Install cloudflared on Pi
            echo "ðŸ’¿ Validating cloudflared installation..."
            REQUIREMENTS+=("âœ“ Installation commands/script")
            REQUIREMENTS+=("âœ“ Service configuration")
            REQUIREMENTS+=("âœ“ Version verification")
            
            if ! echo "$PR_BODY" | grep -iE "(install|apt|dpkg|cloudflared)" > /dev/null; then
              MISSING+=("âŒ Must show installation process")
              VALIDATION_FAILED=true
            fi
            
            if ! echo "$PR_BODY" | grep -iE "(version|cloudflared.*version)" > /dev/null; then
              MISSING+=("âš ï¸ Should verify installed version")
            fi
            ;;
            
          5)
            # Create CloudFlare tunnel service
            echo "ðŸš‡ Validating tunnel service creation..."
            REQUIREMENTS+=("âœ“ Tunnel creation command")
            REQUIREMENTS+=("âœ“ Service configuration file")
            REQUIREMENTS+=("âœ“ Tunnel ID/credentials")
            
            if ! echo "$PR_BODY" | grep -iE "(tunnel.*create|cloudflared.*tunnel)" > /dev/null; then
              MISSING+=("âŒ Must show tunnel creation")
              VALIDATION_FAILED=true
            fi
            
            if ! echo "$PR_BODY" | grep -iE "(config|yml|yaml|ingress)" > /dev/null; then
              MISSING+=("âŒ Must include tunnel configuration")
              VALIDATION_FAILED=true
            fi
            ;;
            
          6|7)
            # VPN sub-tasks
            echo "ðŸ”‘ Validating VPN sub-task..."
            REQUIREMENTS+=("âœ“ UDM Pro configuration steps")
            REQUIREMENTS+=("âœ“ Client device setup")
            REQUIREMENTS+=("âœ“ Connection testing")
            
            if ! echo "$PR_BODY" | grep -iE "(udm|unifi|vpn.*config)" > /dev/null; then
              MISSING+=("âš ï¸ Should document UDM Pro configuration")
            fi
            ;;
            
          8|9|10)
            # Webhook sub-tasks
            echo "âš™ï¸ Validating webhook sub-task..."
            REQUIREMENTS+=("âœ“ Installation/configuration steps")
            REQUIREMENTS+=("âœ“ Security implementation")
            REQUIREMENTS+=("âœ“ Testing verification")
            
            if ! echo "$PR_BODY" | grep -iE "(webhook|deploy|github.*webhook)" > /dev/null; then
              MISSING+=("âŒ Must reference webhook implementation")
              VALIDATION_FAILED=true
            fi
            ;;
            
          11)
            # Integration Testing
            echo "ðŸ§ª Validating integration testing..."
            REQUIREMENTS+=("âœ“ End-to-end test execution")
            REQUIREMENTS+=("âœ“ All components verified")
            REQUIREMENTS+=("âœ“ Performance metrics")
            REQUIREMENTS+=("âœ“ Security validation")
            
            if ! echo "$PR_BODY" | grep -iE "(end.to.end|e2e|integration|full.*test)" > /dev/null; then
              MISSING+=("âŒ Must include end-to-end testing")
              VALIDATION_FAILED=true
            fi
            
            if ! echo "$PR_BODY" | grep -iE "(performance|latency|response.*time)" > /dev/null; then
              MISSING+=("âš ï¸ Should include performance metrics")
            fi
            
            if ! echo "$PR_BODY" | grep -iE "(security|vulnerab|scan|pentest)" > /dev/null; then
              MISSING+=("âš ï¸ Should include security validation")
            fi
            ;;
            
          *)
            echo "â„¹ï¸ No specific validation rules for Issue #${ISSUE_NUM}"
            ;;
        esac
        
        # Generate comprehensive validation report
        COMMENT_HEADER=""
        COMMENT_BODY=""
        
        if [ "$VALIDATION_FAILED" = true ]; then
          COMMENT_HEADER="## ðŸš¨ Issue-Specific Validation Failed"
        elif [ "$NEEDS_MORE_INFO" = true ]; then
          COMMENT_HEADER="## â„¹ï¸ More Information Needed"
        else
          COMMENT_HEADER="## âœ… Issue-Specific Validation Passed"
        fi
        
        COMMENT_BODY="**Issue #${ISSUE_NUM}**: $ISSUE_TITLE_TEXT"
        
        # Add issue type info
        if [ "$IS_SUBTASK" = true ]; then
          COMMENT_BODY="$COMMENT_BODY
        **Type**: Sub-task"
          if [ -n "$PARENT_ISSUE" ]; then
            PARENT_TITLE=$(gh issue view $PARENT_ISSUE --json title | jq -r '.title')
            COMMENT_BODY="$COMMENT_BODY
        **Parent Issue**: #${PARENT_ISSUE} - $PARENT_TITLE"
          fi
        fi
        
        # Add dependency information
        if [ ${#DEPENDENCIES[@]} -gt 0 ]; then
          COMMENT_BODY="$COMMENT_BODY
        **Dependencies**: Issues #$(printf '#%s ' "${DEPENDENCIES[@]}" | sed 's/ $//')"
          if [ ${#UNRESOLVED_DEPS[@]} -gt 0 ]; then
            COMMENT_BODY="$COMMENT_BODY
        âš ï¸ **Unresolved Dependencies**: ${UNRESOLVED_DEPS[*]}"
          fi
        fi
        
        # Add related issues
        if [ -n "$RELATED_ISSUES" ]; then
          COMMENT_BODY="$COMMENT_BODY
        **Related Issues**: #$(echo $RELATED_ISSUES | sed 's/ /, #/g')"
        fi
        
        # Add requirements and validation results
        if [ ${#REQUIREMENTS[@]} -gt 0 ]; then
          COMMENT_BODY="$COMMENT_BODY

        ### Requirements for this issue:
        $(printf '%s\n' "${REQUIREMENTS[@]}")"
        fi
        
        if [ ${#MISSING[@]} -gt 0 ]; then
          if [ "$VALIDATION_FAILED" = true ]; then
            COMMENT_BODY="$COMMENT_BODY

        ### Issues found (must fix):
        $(printf '%s\n' "${MISSING[@]}")"
          else
            COMMENT_BODY="$COMMENT_BODY

        ### Suggestions (non-blocking):
        $(printf '%s\n' "${MISSING[@]}")"
          fi
        fi
        
        # Add next steps
        if [ "$VALIDATION_FAILED" = true ]; then
          COMMENT_BODY="$COMMENT_BODY

        **Next Steps**: Please update your PR to address the issues above."
        elif [ "$NEEDS_MORE_INFO" = true ]; then
          COMMENT_BODY="$COMMENT_BODY

        **Next Steps**: Please provide additional information or clarification as requested."
        else
          COMMENT_BODY="$COMMENT_BODY

        **Status**: âœ… PR meets the specific requirements for this issue!"
          
          # Auto-link related issues if appropriate
          if [ -n "$PARENT_ISSUE" ]; then
            gh issue comment $PARENT_ISSUE --body "ðŸ”— **Sub-task Progress**: PR #${PR_NUMBER} addresses Issue #${ISSUE_NUM}
            
        Related implementation is ready for review." 2>/dev/null || true
          fi
        fi
        
        # Post the comment
        FULL_COMMENT="$COMMENT_HEADER

        $COMMENT_BODY"
        
        gh pr comment $PR_NUMBER --body "$FULL_COMMENT"
        
        if [ "$VALIDATION_FAILED" = true ]; then
          echo "::error::Issue-specific validation failed for Issue #${ISSUE_NUM}"
          exit 1
        else
          echo "âœ… Issue-specific validation completed for Issue #${ISSUE_NUM}"
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}