#!/bin/bash
set -e

echo "ğŸ” Running pre-commit checks..."

# Check if we're in the right directory
if [ ! -f "backend/go.mod" ]; then
  echo "âŒ Not in project root directory"
  exit 1
fi

# Function to check if command exists
command_exists() {
  command -v "$1" >/dev/null 2>&1
}

# Check Go backend
echo "ğŸ”§ Checking Go backend..."
if command_exists go; then
  cd backend
  
  # Check Go modules
  echo "  ğŸ“¦ Verifying Go modules..."
  go mod verify || {
    echo "âŒ Go modules verification failed"
    exit 1
  }
  
  # Check for Go syntax/compile errors
  echo "  ğŸ—ï¸ Building Go backend..."
  go build -o /tmp/sermon-uploader . || {
    echo "âŒ Go build failed"
    exit 1
  }
  
  # Run Go vet (catches common errors)
  echo "  ğŸ” Running go vet..."
  go vet ./... || {
    echo "âŒ Go vet found issues"
    exit 1
  }
  
  # Check Go formatting
  echo "  ğŸ“ Checking Go formatting..."
  UNFORMATTED=$(gofmt -l .)
  if [ -n "$UNFORMATTED" ]; then
    echo "âŒ Go files need formatting:"
    echo "$UNFORMATTED"
    echo "Run: gofmt -w ."
    exit 1
  fi
  
  # Run golangci-lint for comprehensive code quality checks
  echo "  ğŸ” Running golangci-lint..."
  if command_exists golangci-lint; then
    golangci-lint run --config .golangci.yml || {
      echo "âŒ golangci-lint found issues"
      echo "Fix the issues above or run 'golangci-lint run --fix' to auto-fix some issues"
      exit 1
    }
    echo "  âœ… golangci-lint passed"
  else
    echo "  âš ï¸  golangci-lint not found - install it for comprehensive linting"
    echo "     Installation: https://golangci-lint.run/usage/install/"
  fi
  
  cd ..
  echo "âœ… Go backend checks passed"
else
  echo "âš ï¸ Go not found, skipping Go checks"
fi

echo "ğŸ‰ All pre-commit checks passed! Safe to commit."
