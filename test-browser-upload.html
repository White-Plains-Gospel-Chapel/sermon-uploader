<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORS Upload Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
        }
        #results {
            white-space: pre-wrap;
            font-family: monospace;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>🧪 CORS Browser Upload Test</h1>
    
    <div class="test-section">
        <h2>Test Configuration</h2>
        <p>Backend: http://localhost:8000</p>
        <p>MinIO: http://192.168.1.127:9000</p>
    </div>

    <div class="test-section">
        <h2>Test Actions</h2>
        <button onclick="testCORS()">Run CORS Test</button>
        <button onclick="testUpload()">Test File Upload</button>
        <button onclick="testBulkUpload()">Test Bulk Upload (3 files)</button>
    </div>

    <div id="results"></div>

    <script>
        const API_URL = 'http://localhost:8000';
        const resultsDiv = document.getElementById('results');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            resultsDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
        }

        async function testCORS() {
            resultsDiv.innerHTML = '';
            log('Starting CORS test...', 'info');

            try {
                // Step 1: Get presigned URL
                log('1. Requesting presigned URL from backend...', 'info');
                const response = await fetch(`${API_URL}/api/upload/presigned`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filename: `browser-test-${Date.now()}.wav`,
                        fileSize: 100 * 1024 * 1024 // 100MB
                    })
                });

                if (!response.ok) {
                    throw new Error(`Backend error: ${response.status}`);
                }

                const data = await response.json();
                log(`✅ Got presigned URL (${data.uploadMethod})`, 'success');

                // Step 2: Test CORS preflight
                log('2. Testing CORS preflight to MinIO...', 'info');
                const corsResponse = await fetch(data.uploadUrl, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'PUT',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });

                if (corsResponse.ok) {
                    log('✅ CORS preflight successful', 'success');
                    log(`   Allow-Origin: ${corsResponse.headers.get('Access-Control-Allow-Origin')}`, 'info');
                } else {
                    log(`❌ CORS preflight failed: ${corsResponse.status}`, 'error');
                }

                // Step 3: Test actual upload
                log('3. Testing actual upload with CORS...', 'info');
                const testData = new Uint8Array(1024); // 1KB test
                const uploadResponse = await fetch(data.uploadUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'audio/wav'
                    },
                    body: testData
                });

                if (uploadResponse.ok) {
                    log('✅ Upload successful with CORS!', 'success');
                } else {
                    log(`❌ Upload failed: ${uploadResponse.status}`, 'error');
                }

            } catch (error) {
                log(`❌ Test failed: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function testUpload() {
            resultsDiv.innerHTML = '';
            log('Starting single file upload test...', 'info');

            try {
                // Create a test WAV file
                const wavData = createWAVFile(1024 * 1024); // 1MB
                const file = new File([wavData], `upload-test-${Date.now()}.wav`, { type: 'audio/wav' });

                log(`Created test file: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`, 'info');

                // Get presigned URL
                const response = await fetch(`${API_URL}/api/upload/presigned`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: file.name,
                        fileSize: file.size
                    })
                });

                const data = await response.json();
                log(`Got presigned URL (${data.uploadMethod})`, 'info');

                // Upload file
                log('Uploading file...', 'info');
                const startTime = Date.now();
                
                const uploadResponse = await fetch(data.uploadUrl, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'audio/wav' },
                    body: file
                });

                const duration = Date.now() - startTime;

                if (uploadResponse.ok) {
                    log(`✅ Upload successful in ${duration}ms!`, 'success');
                } else {
                    log(`❌ Upload failed: ${uploadResponse.status}`, 'error');
                }

            } catch (error) {
                log(`❌ Test failed: ${error.message}`, 'error');
            }
        }

        async function testBulkUpload() {
            resultsDiv.innerHTML = '';
            log('Starting bulk upload test (3 files)...', 'info');

            try {
                // Create test files
                const files = [
                    { name: `bulk-1-${Date.now()}.wav`, size: 50 * 1024 * 1024 },  // 50MB
                    { name: `bulk-2-${Date.now()}.wav`, size: 100 * 1024 * 1024 }, // 100MB
                    { name: `bulk-3-${Date.now()}.wav`, size: 150 * 1024 * 1024 }, // 150MB
                ];

                log(`Testing ${files.length} files (${files.reduce((a, b) => a + b.size, 0) / 1024 / 1024} MB total)`, 'info');

                // Get batch presigned URLs
                const response = await fetch(`${API_URL}/api/upload/presigned-batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        files: files.map(f => ({ filename: f.name, fileSize: f.size }))
                    })
                });

                const data = await response.json();
                log(`Got ${Object.keys(data.results).length} presigned URLs`, 'info');

                // Test CORS for each
                let successCount = 0;
                for (const [filename, urlInfo] of Object.entries(data.results)) {
                    if (urlInfo.uploadUrl) {
                        log(`Testing CORS for ${filename}...`, 'info');
                        
                        const corsResponse = await fetch(urlInfo.uploadUrl, {
                            method: 'OPTIONS',
                            headers: {
                                'Origin': window.location.origin,
                                'Access-Control-Request-Method': 'PUT'
                            }
                        });

                        if (corsResponse.ok) {
                            successCount++;
                            log(`  ✅ CORS OK for ${filename}`, 'success');
                        } else {
                            log(`  ❌ CORS failed for ${filename}`, 'error');
                        }
                    }
                }

                log(`\nResults: ${successCount}/${files.length} files passed CORS check`, 
                    successCount === files.length ? 'success' : 'error');

            } catch (error) {
                log(`❌ Test failed: ${error.message}`, 'error');
            }
        }

        function createWAVFile(size) {
            // Create a valid WAV header
            const header = new Uint8Array(44);
            
            // RIFF chunk
            header[0] = 0x52; header[1] = 0x49; header[2] = 0x46; header[3] = 0x46; // "RIFF"
            const fileSize = size - 8;
            header[4] = fileSize & 0xff;
            header[5] = (fileSize >> 8) & 0xff;
            header[6] = (fileSize >> 16) & 0xff;
            header[7] = (fileSize >> 24) & 0xff;
            header[8] = 0x57; header[9] = 0x41; header[10] = 0x56; header[11] = 0x45; // "WAVE"
            
            // fmt chunk
            header[12] = 0x66; header[13] = 0x6d; header[14] = 0x74; header[15] = 0x20; // "fmt "
            header[16] = 16; // chunk size
            header[20] = 1;  // audio format (PCM)
            header[22] = 2;  // channels
            header[24] = 0x44; header[25] = 0xac; // sample rate (44100)
            header[32] = 4;  // block align
            header[34] = 16; // bits per sample
            
            // data chunk
            header[36] = 0x64; header[37] = 0x61; header[38] = 0x74; header[39] = 0x61; // "data"
            const dataSize = size - 44;
            header[40] = dataSize & 0xff;
            header[41] = (dataSize >> 8) & 0xff;
            header[42] = (dataSize >> 16) & 0xff;
            header[43] = (dataSize >> 24) & 0xff;
            
            // Create full file
            const fullData = new Uint8Array(size);
            fullData.set(header, 0);
            
            return fullData;
        }

        // Auto-run CORS test on load
        window.addEventListener('load', () => {
            log('Page loaded. Click buttons to run tests.', 'info');
        });
    </script>
</body>
</html>